let cursorX=0,cursorY=0,prevCursorX=0,prevCursorY=0,plantedWords=[],gridWidth=20,gridHeight=12,symbols="!@#$%^&*()[]{}<>?/+=|~",attemptsRemaining=4,highlightRange=null,offsetX=15,correctPassword=null,grid=[],foundSnippets=[],inputBlocked=!1,terminalLog=[],showWarning=!1,G=Graphics.createArrayBuffer(400,308,2,{msb:!0,buffer:E.toArrayBuffer(E.memoryArea(268451840,30800))});G.flip=()=>Pip.blitImage(G,40,7);function fillGrid(){grid=[];for(let y=0;y<gridHeight;y++){let r="";for(let x=0;x<gridWidth;x++)r+=symbols[Math.random()*symbols.length|0];grid.push(r)}}function scanForSnippets(){foundSnippets=[];const p={"(":")","{":"}","[":"]","<":">"};for(let r=0;r<gridHeight;r++){let l=grid[r],w=plantedWords.filter(x=>x.row===r);for(let i=0;i<l.length;i++){let o=l[i];if(p[o])for(let j=i+1;j<=i+10&&j<l.length;j++)if(l[j]===p[o]){if(!w.some(x=>(x.startCol>i&&x.startCol<j)||(i>x.startCol&&i<x.startCol+x.word.length)||(j>x.startCol&&j<x.startCol+x.word.length)))foundSnippets.push({row:r,startCol:i,endCol:j,pair:o+p[o],active:!0});break}}}}function drawCharAt(r,c){let w=15,h=18,y=50,ch=grid[r][c],px=offsetX+c*w,py=y+r*h,isCur=r===cursorY&&c===cursorX,rowW=plantedWords.filter(w=>w.row===cursorY),hWord=rowW.find(w=>cursorX>=w.startCol&&cursorX<w.startCol+w.word.length),inHWord=hWord&&r===cursorY&&c>=hWord.startCol&&c<hWord.startCol+hWord.word.length,snips=foundSnippets.filter(s=>s.active&&s.row===cursorY&&cursorX>=s.startCol&&cursorX<=s.endCol),fSnip=snips.sort((a,b)=>Math.abs(cursorX-a.startCol)-Math.abs(cursorX-b.startCol))[0],inSnip=fSnip&&r===cursorY&&c>=fSnip.startCol&&c<=fSnip.endCol;if(isCur||inHWord||inSnip){G.setColor(3);G.fillRect(px-1,py-1,px+w-1,py+h-1);G.setColor(0)}else{G.setColor(0);G.fillRect(px-1,py-1,px+w-1,py+h-1);G.setColor(3)}G.drawString(ch,px,py)}function updateCursor(){for(let c=0;c<gridWidth;c++){drawCharAt(prevCursorY,c);if(cursorY!==prevCursorY)drawCharAt(cursorY,c)}prevCursorX=cursorX;prevCursorY=cursorY;G.flip()}function drawGrid(){let w=15,h=18,y=50;G.clear();G.setFont("6x8",2);G.setColor(3);G.drawString("ATTEMPTS REMAINING:",offsetX,7);for(let i=0;i<4;i++){let x=offsetX+i*30;i<attemptsRemaining?G.fillRect(x,28,x+10,40):G.drawRect(x,28,x+10,40)}for(let r=0;r<gridHeight;r++)for(let c=0;c<gridWidth;c++)drawCharAt(r,c);if(attemptsRemaining===1&&showWarning){G.setColor(3);G.setFont("6x8",2);G.drawString("!!!WARNING: LOCKOUT IMMINENT!!!",offsetX,y+gridHeight*h+5)}G.flip()}function updateHighlightRange(){highlightRange=null}function getRandomWords(w,c){return w.slice().sort(()=>.5-Math.random()).slice(0,c)}const allWords=["HACK","BIKE","HIKE","VOID","VEIN","RAINING","NULL","PULLING","DATA","BAIT","HOARD","ROOTING","HEX","DEBUG","SCRIPT","LOGIC","STACK","ARRAY","OBJECT","STRINGING","BRINGING","MODULE","IMPORT","EXPORT","EVENT","REACT","PACK","BACK","HANK","HARK","HALL","LIKE","PIKE","BAKE","BITE","BIND","VINE","VILE","VOYAGE","MOID","SOIL","GAINING","PAINTED","RAVINGS","MAILING","WAILING","RAILING","ARROW","SUBJECT","EJECTS","ABJECT","REJECT","OBSESS","JANE","MARK","MARY","FREEDOM","FRENCH","FLEETING","FLOP","VAULT"];function plantWords(w){plantedWords=[];for(let word of w){if(word.length>=gridWidth)continue;let p=!1;for(let a=0;a<20&&!p;a++){let r=Math.random()*gridHeight|0,c=Math.random()*(gridWidth-word.length)|0,line=grid[r].split("");if(line.slice(c,c+word.length).some(ch=>!symbols.includes(ch)))continue;for(let j=0;j<word.length;j++)line[c+j]=word[j];grid[r]=line.join("");plantedWords.push({row:r,startCol:c,word});p=!0}}}function pickCorrectPassword(w){correctPassword=w[Math.random()*w.length|0]}function drawTerminal(){let x=330,b=200,l=18;G.setFont("6x8",2);G.setColor(3);let m=Math.floor((b-50)/l),s=Math.max(0,terminalLog.length-m);for(let i=0;i<m;i++){let j=s+i;if(j>=terminalLog.length)break;G.drawString(terminalLog[j],x,50+i*l)}}function startGame(){showWarning=!1;attemptsRemaining=4;cursorX=cursorY=0;inputBlocked=!1;let wc=8+Math.random()*7|0,words=getRandomWords(allWords,wc);fillGrid();plantWords(words);pickCorrectPassword(words);scanForSnippets();drawGrid();bindControls()}function bindControls(){Pip.removeAllListeners("knob1");Pip.on("knob1",v=>{if(inputBlocked)return;if(v!==0){cursorY+=v>0?-1:1;cursorY=Math.max(0,Math.min(cursorY,gridHeight-1));updateHighlightRange();updateCursor()}else handleSelection()});Pip.removeAllListeners("knob2");Pip.on("knob2",v=>{if(inputBlocked)return;if(v!==0){cursorX+=v>0?1:-1;cursorX=Math.max(0,Math.min(cursorX,gridWidth-1));updateHighlightRange();updateCursor()}});Pip.removeAllListeners("torch");Pip.on("torch",v=>{if(v!==0)E.reboot()})}function handleSelection(){if(attemptsRemaining===1)showWarning=!0;if(inputBlocked)return;let rw=plantedWords.filter(w=>w.row===cursorY),sel=rw.find(w=>cursorX>=w.startCol&&cursorX<w.startCol+w.word.length),ms=foundSnippets.filter(s=>s.active&&s.row===cursorY&&cursorX>=s.startCol&&cursorX<=s.endCol),ss=ms.sort((a,b)=>(a.endCol-a.startCol)-(b.endCol-b.startCol))[0];if(sel){let l=0;for(let i=0;i<sel.word.length;i++)if(sel.word[i]===correctPassword[i])l++;addToTerminal(">"+sel.word+" ["+l+"]");if(sel.word===correctPassword){G.clear();G.setColor(3);G.setFont("6x8",2);let m1="SUCCESS!",m2="UPLOADING...",x1=(G.getWidth()-G.stringWidth(m1))/2,x2=(G.getWidth()-G.stringWidth(m2))/2,y=G.getHeight()/2;G.drawString(m1,x1,y-20);G.drawString(m2,x2,y);G.flip();Pip.removeAllListeners();inputBlocked=!0;setTimeout(()=>E.reboot(),3e3)}else{attemptsRemaining--;if(attemptsRemaining<=0){inputBlocked=!0;G.clear();G.setColor(3);G.setFont("6x8",2);G.drawString("ACCESS DENIED!",20,G.getHeight()/2-20);G.drawString("REBOOTING...",20,G.getHeight()/2);G.flip();setTimeout(()=>{inputBlocked=!1;terminalLog=[];highlightRange=correctPassword=null;plantedWords=foundSnippets=[];startGame()},2e3)}else updateDisplay()}}else if(ss&&ss.active){ss.active=!1;let msg="";if(Math.random()<.5){let d=plantedWords.filter(w=>w.word!==correctPassword);if(d.length>0){let dud=d[Math.random()*d.length|0],line=grid[dud.row].split("");for(let i=0;i<dud.word.length;i++)line[dud.startCol+i]=".";grid[dud.row]=line.join("");plantedWords=plantedWords.filter(w=>w!==dud);msg=">DUD REMOVED"}else msg=">NO DUDS REMAIN"}else{attemptsRemaining=4;msg=">TRIES RESET"}addToTerminal(msg);updateDisplay()}}function addToTerminal(msg){for(let i=0;i<msg.length;i+=5)terminalLog.push(msg.slice(i,i+5));if(terminalLog.length>10)terminalLog.splice(0,terminalLog.length-10)}function drawWarningLine(){let h=18,y=50+gridHeight*h+5;G.setColor(0);G.fillRect(offsetX,y,400,y+h);if(showWarning){G.setColor(3);G.setFont("6x8",2);G.drawString("!!!WARNING: LOCKOUT IMMINENT!!!",offsetX,y)}}function updateDisplay(){if(attemptsRemaining===1)showWarning=!0;drawGrid();drawTerminal();G.flip();drawGrid();drawTerminal();G.flip()}function showLoadingScreen(cb){let m=["CONNECTING TO DEVICE.","CONNECTING TO DEVICE..","CONNECTING TO DEVICE...","CONNECTED!"],i=0;G.clear();G.setFont("6x8",2);G.setColor(3);function showNext(){G.clear();let msg=m[i],tw=G.stringWidth(msg),x=(G.getWidth()-tw)/2,y=(G.getHeight()-16)/2;G.drawString(msg,x,y);G.flip();i++;if(i<m.length)setTimeout(showNext,1e3);else setTimeout(cb,300)}showNext()}showLoadingScreen(startGame);
